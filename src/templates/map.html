<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diaries of the Upheaval - Map</title>
    <!-- Link to Leaflet.js CSS for styling the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        /* Basic styling to make the map fill the entire screen */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000; /* Black background for loading */
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- The div where the map will be rendered -->
    <div id="map"></div>

    <!-- Link to Leaflet.js library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- INITIALIZATION ---

        // Get the URL parameters to know what to display
        const urlParams = new URLSearchParams(window.location.search);
        const layer = urlParams.get('layer') || 'surface'; // Default to surface
        const locName = urlParams.get('name') || 'Location';
        const iconUrl = urlParams.get('icon');
        const x = parseFloat(urlParams.get('x')) || 0;
        const y = parseFloat(urlParams.get('y')) || 0;

        // --- LEAFLET.JS CONFIGURATION ---

        // Define the custom Coordinate Reference System (CRS) for the Zelda map.
        // This transformation is the magic that makes the in-game coordinates work with Leaflet.
        const TotkCRS = L.Util.extend({}, L.CRS.Simple, {
            transformation: new L.Transformation(1 / 128, 0, -1 / 128, 0)
        });

        // Initialize the map in our 'map' div
        const map = L.map('map', {
            crs: TotkCRS,
            minZoom: 0,
            maxZoom: 7,
            center: [y, x], // Leaflet uses [lat, lng] which corresponds to [y, x]
            zoom: 5, // A good starting zoom level
            zoomControl: true,
            attributionControl: false,
            preferCanvas: true,
            markerZoomAnimation: false,
        });

        // Define the tile layer using the files you downloaded
        L.tileLayer(`/assets/tiles/${layer}/{z}/{x},{y}.png`, {
            tileSize: 256,
            minZoom: 0,
            maxZoom: 7,
            noWrap: true,
            bounds: [[-6000, -6000], [6000, 6000]] // Define the boundaries of the map
        }).addTo(map);

        // --- MARKER PLACEMENT ---

        // Check if an icon was provided in the URL
        if (iconUrl) {
            // Create a custom icon using the image from our assets
            const customIcon = L.icon({
                iconUrl: `/assets/icons/${iconUrl}`,
                iconSize: [32, 32], // Adjust size as needed
                iconAnchor: [16, 16], // Center of the icon
                popupAnchor: [0, -16] // Where the popup should open relative to the icon
            });

            // Create a marker with the custom icon and add it to the map
            const marker = L.marker([y, x], { icon: customIcon }).addTo(map);

            // Add a popup to the marker that shows the location's name
            marker.bindPopup(`<b>${locName}</b>`).openPopup();
        } else {
            // If no icon, just place a default circle marker
            L.circleMarker([y, x], { radius: 8, color: 'red' }).addTo(map)
              .bindPopup(`<b>${locName}</b>`).openPopup();
        }
    </script>
</body>
</html>
